{% extends "base.html" %}
{% block title %}Product Order{% endblock %}
{% block head %}
    <!-- สำหรับค้นหา choice -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>

{% endblock %}
{% block content %}
<script>
    function updateFinalTotal() {
        let total = 0;
        let num = 0;

        const totalFields = document.querySelectorAll('.total-cost');

        totalFields.forEach(function(field) {
            const value = parseFloat(field.textContent.replace(' บาท', '')) || 0;
            total += value;
        });

        const product_quantity = document.querySelectorAll('.product_quantity')

        product_quantity.forEach(function(field) {
            const quantity = parseInt(field.value) || 0;
            num += quantity;
        });

        const totalPriceElement = document.getElementById('total_price');
        const totalItemElement = document.getElementById('total_item');
        if (totalPriceElement) {
            totalPriceElement.textContent = "ราคารวม: " + total.toFixed(2) + " บาท";
            totalPriceElement.value = total.toFixed(2);
        }

        if (totalItemElement) {
            totalItemElement.textContent = "จำนวนสินค้าทั้งหมด: " + num + " ชิ้น";
        }
    }

    function updateTotal(rowId) {
        const quantityField = document.querySelector(`#form-${rowId} input[name$='quantity']`);
        const unitCostField = document.querySelector(`#form-${rowId} input[name$='unit_cost']`);
        const totalField = document.querySelector(`#form-${rowId} .total-cost`);

        const quantity = parseFloat(quantityField.value) || 0;
        const unitCost = parseFloat(unitCostField.value) || 0;
        const total = quantity * unitCost;

        totalField.textContent = total.toFixed(2) + " บาท";
        updateFinalTotal()
    }

    document.addEventListener('DOMContentLoaded', function() {
        updateFinalTotal()
    });

</script>
<form method="post" style="all:unset;">
    {% csrf_token%}
    <div class="container mt-5">
        <h1 class="text-center">Order Products from Supplier</h1>

        <div class="product-list">
            <h3>Products</h3>
            <table class="table table-bordered">
                <thead class="thead-light">
                    <tr>
                        <th>Product Name</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="formset-container">
                    {{ formset.management_form }}
                    {% for form in formset %}
                        <tr id="form-{{ forloop.counter0 }}">
                            <td style="width: 40%;">
                                {{ form.product }}
                                <div class="form-text text-danger">{{ form.product.errors }}</div>
                            </td>
                            <td style="width: 20%;">
                                {{ form.quantity }}
                                <div class="form-text text-danger">{{ form.quantity.errors }}</div>
                            </td>
                            <td style="width: 20%;">
                                {{ form.unit_cost }}
                                <div class="form-text text-danger">{{ form.unit_cost.errors }}</div>
                            </td>
                            <td class="total-cost" style="width: 20%;">0.00 บาท</td>

                            {% if forloop.last %}
                            <td style="width: 5%;">
                                <button type="submit" name="delete_product" class="btn btn-danger">X</button>
                            </td>
                            {% endif %}
                            <script>
                                updateTotal('{{ forloop.counter0 }}');
                                document.querySelector(`#form-{{ forloop.counter0 }} input[name$='quantity']`).addEventListener('input', function() {
                                    updateTotal('{{ forloop.counter0 }}');
                                });
                                document.querySelector(`#form-{{ forloop.counter0 }} input[name$='unit_cost']`).addEventListener('input', function() {
                                    updateTotal('{{ forloop.counter0 }}');
                                });
                                $(".product-select").select2({
                                    placeholder: "เลือกสินค้า",
                                    allowClear: true
                                });
                            </script>
                        </tr>
                        
                    {% endfor %}
                </tbody>
            </table>
            <button class="btn btn-info" type="submit" name="add_product">เพิ่มสินค้า</button>
        <div class="card mt-4">
            <div class="card-body">
                <h3 class="card-title">Order Summary</h3>
                <p id="total_item"></p>
                <p>ราคารวมทั้งหมด <input id="total_price" name="total_price" readonly> บาท</p>
            </div>
        </div>

        <div class="text-center mt-4">
            <button class="btn btn-success" type="submit" name="order">ยืนยัน</button>
        </div>
        
    </div>
</form>
{% endblock %}